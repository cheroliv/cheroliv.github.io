<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cheroliv - Développeur Formateur | Ingénierie Pédagogique</title>

    <script>
        // IIFE to avoid polluting global scope
        (function() {
          try {
            const theme = localStorage.getItem('preferred-theme');
            if (theme) {
              document.documentElement.setAttribute('data-bs-theme', theme);
            }
          } catch (e) {
            // Reading from localStorage can fail in private browsing mode on some browsers
            console.warn('Could not set theme from localStorage', e);
          }
        })();
    </script>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- intl-tel-input CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@25.10.1/build/css/intlTelInput.css">

    <!-- Custom CSS -->
    <link href="../../css/styles.css" rel="stylesheet" />

    <!-- highlight.js: theme will be managed dynamically by script.js -->
    <link id="highlight-js-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">

    <link href="../../css/asciidoctor.css" rel="stylesheet"/>



    <!-- Favicon -->
    <link rel="shortcut icon"
          href="../..//img/cheroliv_logo_icon.png"/>



    <!-- Meta tags pour SEO -->
    <meta name="description" content="Développeur formateur spécialisé en ingénierie pédagogique. Conception et développement de solutions e-learning innovantes."/>
    <meta name="keywords" content="développement, formation, e-learning, ingénierie pédagogique, JavaScript, Bootstrap"/>
    <meta name="author" content="Cheroliv"/>
</head>
<body>
<div class="main-content-wrapper">
    <div>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="../../index.html#home">
                <i class="bi bi-code-slash me-2"></i>
                Cheroliv
            </a>

            <button class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav"
                    aria-controls="navbarNav"
                    aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-start">
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html#home">Accueil</a>
                    </li>
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" th:href="${isIndexPage ? '#about' : content.rootpath + 'index.html#about'}">À propos</a>-->
<!--                    </li>-->
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html#services">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html#expertise">Expertise</a>
                    </li>
<!--                    <li class="nav-item"> -->
<!--                        <a class="nav-link" th:href="${isIndexPage ? '#formations' : content.rootpath + 'index.html#formations'}">Formations</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" th:href="${isIndexPage ? '#portfolio' : content.rootpath + 'index.html#portfolio'}">Portfolio</a>-->
<!--                    </li>-->
                    <li class="nav-item">
                        <a class="nav-link" href="../../blog.html">Blog</a>
                    </li>
<!--                    <li class="nav-item dropdown">-->
<!--                        <a class="nav-link dropdown-toggle"-->
<!--                           href="#"-->
<!--                           id="memosDropdown"-->
<!--                           role="button"-->
<!--                           data-bs-toggle="dropdown"-->
<!--                           aria-expanded="false">-->
<!--                            <i class="fa-duotone fa-memo"></i> Memos-->
<!--                        </a>-->
<!--                        <ul class="dropdown-menu" aria-labelledby="memosDropdown">-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2022/0052_memo_jvm_post.html'}"><i class="fa-brands fa-java"></i> jvm</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2022/0053_memo_kotlin_post.html'}"><i class="fa-brands fa-korvue"></i> kotlin</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2022/0047_memo_gradle_post.html'}"><i class="fa-solid fa-industry"></i> gradle</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2023/0060_memo_js_post.html'}"><i class="fa-brands fa-square-js"></i> javascript</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2023/0063_memo_ts_post.html'}"><i class="fa-brands fa-square-js"></i> typescript</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2023/0062_memo_css_post.html'}"><i class="fa-brands fa-css3-alt"></i> css</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2023/0061_memo_html_post.html'}"><i class="fa-brands fa-html5"></i> html</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2023/0066_memo_python_post.html'}"><i class="fa-brands fa-python"></i> python</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2020/0021_memo_git_post.html'}"><i class="fa-brands fa-git-alt"></i> git</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2021/0030_memo_linux_post.html'}"><i class="fa-brands fa-linux"></i> linux</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2022/0054_memo_cadrage_post.html'}"><i class="fa-solid fa-arrows-split-up-and-left"></i> cadrage</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2022/0031_memo_design_system_post.html'}"><i class="fa-solid fa-pencil"></i> design system</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{${content.rootpath} + 'blog/2020/0016_asciidoc_markdown_memo_post.html'}"><i class="fa-brands fa-markdown"></i> asciidoc/markdown</a></li>-->
<!--                        </ul>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" th:href="${isIndexPage ? '#contact' : content.rootpath + 'index.html#contact'}">Contact</a>-->
<!--                    </li>-->

                    <li class="nav-item">
                        <a class="nav-link" href="mailto:cheroliv.developer@gmail.com">Contact</a>
                    </li>
                </ul>
                <!-- Theme Switcher moved outside the ul for simpler flexbox calculation -->
                <div class="nav-item dropdown theme-switcher-container ms-lg-3">
                    <button class="btn btn-outline-secondary dropdown-toggle theme-dropdown-btn"
                            type="button"
                            id="themeDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Sélectionner le thème de l'interface">
                        <i class="bi bi-sun"></i>
                        <span id="current-theme" class="visually-hidden">Light</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                        <li><button class="dropdown-item theme-option"
                                    type="button"
                                    data-theme="light">
                            <i class="bi bi-sun me-2"></i>Light
                        </button></li>
                        <li><button class="dropdown-item theme-option" type="button" data-theme="dark">
                            <i class="bi bi-moon me-2"></i>Dark
                        </button></li>
                        <li><button class="dropdown-item theme-option" type="button" data-theme="high-contrast">
                            <i class="bi bi-circle-half me-2"></i>High Contrast
                        </button></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
</div>
    <main class="container main-content-padding" id="main-content">
        <article>
            <header class="page-header mb-4">
                <h1 class="h2">Debugging Mockito: Résoudre l&#39;erreur &quot;Wanted but not invoked&quot; dans les tests de plugins Gradle</h1>
                <p class="lead">
                    <em>Publié le 17 November 2025</em>
                </p>
            </header>

            <div class="content"><div id="toc" class="toc">
<div id="toctitle">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#le_contexte_plugin_gradle_bakery">2. Le contexte : Plugin Gradle Bakery</a></li>
<li><a href="#problème_1_vérifier_le_mauvais_mock">3. Problème #1 : Vérifier le mauvais mock</a>
<ul class="sectlevel2">
<li><a href="#le_diagnostic">3.1. Le diagnostic</a></li>
<li><a href="#la_solution">3.2. La solution</a></li>
</ul>
</li>
<li><a href="#problème_2_unfinishedstubbingexception_en_cascade">4. Problème #2 : UnfinishedStubbingException en cascade</a>
<ul class="sectlevel2">
<li><a href="#le_diagnostic_2">4.1. Le diagnostic</a></li>
<li><a href="#la_solution_2">4.2. La solution</a></li>
</ul>
</li>
<li><a href="#problème_3_le_fichier_de_configuration_nexiste_pas">5. Problème #3 : Le fichier de configuration n&#8217;existe pas</a>
<ul class="sectlevel2">
<li><a href="#le_diagnostic_3">5.1. Le diagnostic</a></li>
<li><a href="#la_solution_3">5.2. La solution</a></li>
</ul>
</li>
<li><a href="#problème_4_afterevaluate_et_nullpointerexception">6. Problème #4 : afterEvaluate et NullPointerException</a>
<ul class="sectlevel2">
<li><a href="#le_diagnostic_4">6.1. Le diagnostic</a></li>
<li><a href="#la_solution_4">6.2. La solution</a></li>
</ul>
</li>
<li><a href="#la_solution_complète">7. La solution complète</a></li>
<li><a href="#leçons_apprises">8. Leçons apprises</a>
<ul class="sectlevel2">
<li><a href="#1_vérifier_le_bon_mock">8.1. 1. Vérifier le bon mock</a></li>
<li><a href="#2_éviter_les_mocks_imbriqués">8.2. 2. Éviter les mocks imbriqués</a></li>
<li><a href="#3_mocker_les_callbacks_dévaluation">8.3. 3. Mocker les callbacks d&#8217;évaluation</a></li>
<li><a href="#4_tester_la_résolution_des_chemins">8.4. 4. Tester la résolution des chemins</a></li>
</ul>
</li>
<li><a href="#architecture_de_test_finale">9. Architecture de test finale</a></li>
<li><a href="#conclusion">10. Conclusion</a></li>
<li><a href="#ressources">11. Ressources</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lors du développement du plugin Gradle <strong>Bakery</strong> pour mon blog JBake, j&#8217;ai rencontré un problème apparemment simple : un test unitaire qui échouait avec l&#8217;erreur <code>Wanted but not invoked</code>. Ce qui semblait être un bug trivial s&#8217;est révélé être un cas d&#8217;école parfait pour comprendre les subtilités du mocking avec Mockito et Kotlin.</p>
</div>
<div class="paragraph">
<p>Dans cet article, je vous emmène dans un voyage de debugging méthodique, où chaque solution révèle un nouveau problème, jusqu&#8217;à la résolution finale.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="le_contexte_plugin_gradle_bakery">2. Le contexte : Plugin Gradle Bakery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le plugin Bakery est un wrapper autour de JBake qui facilite la publication de sites statiques. Voici sa structure simplifiée :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">class BakeryPlugin : Plugin&lt;Project&gt; {
    override fun apply(project: Project) {
        val extension = project.extensions.create(
            "bakery",
            BakeryExtension::class.java
        )

        project.afterEvaluate {
            if (!project.layout.projectDirectory.asFile
                    .resolve(extension.configPath.get()).exists()) {
                println("config file does not exists")
            } else {
                // C'EST ICI QUE ÇA SE PASSE
                project.plugins.apply(JBakePlugin::class.java)

                val site = FileSystemManager.from(project, extension.configPath.get())
                // Configuration de JBake...
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le test qui échouait était simple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Test
fun `plugin applies jbake gradle plugin`() {
    val project = createMockProject()
    val plugin = BakeryPlugin()

    plugin.apply(project)

    verify(project.plugins).apply(JBakePlugin::class.java)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;erreur :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Wanted but not invoked:
pluginContainer.apply(class org.jbake.gradle.JBakePlugin);
Actually, there were zero interactions with this mock.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problème_1_vérifier_le_mauvais_mock">3. Problème #1 : Vérifier le mauvais mock</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="le_diagnostic">3.1. Le diagnostic</h3>
<div class="imageblock">
<div class="content">
<img src="./images/mockito-problem-1.svg" alt="mockito problem 1" width="687" height="521">
</div>
</div>
<div class="paragraph">
<p>Le problème : Mockito ne peut pas tracer les interactions sur <code>project.plugins</code> car ce n&#8217;est qu&#8217;un getter qui retourne le vrai mock <code>mockPluginContainer</code>. La vérification doit se faire directement sur l&#8217;instance du mock.</p>
</div>
</div>
<div class="sect2">
<h3 id="la_solution">3.2. La solution</h3>
<div class="paragraph">
<p>Modifier <code>createMockProject()</code> pour retourner les deux objets :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">private fun createMockProject(): Pair&lt;Project, PluginContainer&gt; {
    val mockPluginContainer = mock&lt;PluginContainer&gt;()
    val mockProject = mock&lt;Project&gt; {
        on { plugins } doReturn mockPluginContainer
    }
    return Pair(mockProject, mockPluginContainer)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et adapter le test :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Test
fun `plugin applies jbake gradle plugin`() {
    val (project, mockPluginContainer) = createMockProject()
    val plugin = BakeryPlugin()

    plugin.apply(project)

    // ✅ Vérification directe sur le bon mock
    verify(mockPluginContainer).apply(JBakePlugin::class.java)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problème_2_unfinishedstubbingexception_en_cascade">4. Problème #2 : UnfinishedStubbingException en cascade</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="le_diagnostic_2">4.1. Le diagnostic</h3>
<div class="paragraph">
<p>Une fois la première correction appliquée, une nouvelle erreur est apparue :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">UnfinishedStubbingException:
Unfinished stubbing detected here
Hints:
 3. you are stubbing the behaviour of another mock inside
    before 'thenReturn' instruction is completed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code problématique utilisait la syntaxe DSL de Mockito-Kotlin :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">val mockProject = mock&lt;Project&gt; {
    on { extensions } doReturn mockExtensionContainer
    on { plugins } doReturn mockPluginContainer
    on { logger } doReturn mock()  // ❌ PROBLÈME ICI !
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/mockito-problem-2.svg" alt="mockito problem 2" width="690" height="316">
</div>
</div>
</div>
<div class="sect2">
<h3 id="la_solution_2">4.2. La solution</h3>
<div class="paragraph">
<p>Créer <strong>tous</strong> les mocks en dehors de tout bloc de stubbing, puis les configurer avec <code>whenever()</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">private fun createMockProject(): Pair&lt;Project, PluginContainer&gt; {
    // 1️⃣ Créer TOUS les mocks d'abord
    val mockPluginContainer = mock&lt;PluginContainer&gt;()
    val mockExtensionContainer = mock&lt;ExtensionContainer&gt;()
    val mockLogger = mock&lt;org.gradle.api.logging.Logger&gt;()
    val mockProject = mock&lt;Project&gt;()

    // 2️⃣ Configurer les mocks séparément avec whenever()
    whenever(mockProject.plugins).thenReturn(mockPluginContainer)
    whenever(mockProject.extensions).thenReturn(mockExtensionContainer)
    whenever(mockProject.logger).thenReturn(mockLogger)

    return Pair(mockProject, mockPluginContainer)
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Règle d&#8217;or</strong> : Ne jamais appeler <code>mock()</code> à l&#8217;intérieur d&#8217;un bloc de configuration de mock. Toujours créer les mocks en premier, puis les configurer.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problème_3_le_fichier_de_configuration_nexiste_pas">5. Problème #3 : Le fichier de configuration n&#8217;existe pas</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="le_diagnostic_3">5.1. Le diagnostic</h3>
<div class="paragraph">
<p>Même avec les mocks corrects, le test échouait toujours car le plugin ne trouvait pas le fichier de configuration :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// Dans BakeryPlugin.kt
if (!project.layout.projectDirectory.asFile
        .resolve(extension.configPath.get()).exists()) {
    println("config file does not exists")
    return@afterEvaluate  // ❌ Sort avant d'appliquer JBake !
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/mockito-problem-3.svg" alt="mockito problem 3" width="530" height="373">
</div>
</div>
</div>
<div class="sect2">
<h3 id="la_solution_3">5.2. La solution</h3>
<div class="paragraph">
<p>Configurer les mocks pour que la résolution du chemin fonctionne :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">private fun createMockProject(): Pair&lt;Project, PluginContainer&gt; {
    // ... autres mocks ...

    val configFile = File("../../site.yml").canonicalFile
    val projectDir = configFile.parentFile

    // Configuration cohérente des chemins
    whenever(mockConfigPathProperty.get()).thenReturn("site.yml")
    whenever(mockProjectDirectory.asFile).thenReturn(projectDir)

    // Maintenant : projectDir.resolve("site.yml") existe ! ✅
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/path-resolution.svg" alt="path resolution" width="604" height="189">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problème_4_afterevaluate_et_nullpointerexception">6. Problème #4 : afterEvaluate et NullPointerException</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="le_diagnostic_4">6.1. Le diagnostic</h3>
<div class="paragraph">
<p>Le plugin applique JBake dans un bloc <code>afterEvaluate</code>, et accède à <code>buildDirectory.dir()</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">project.afterEvaluate {
    // ...
    project.tasks.withType(JBakeTask::class.java)
        .getByName("bake").apply {
            output = project.layout.buildDirectory
                .dir(site.bake.destDirPath)  // ❌ NPE ici !
                .get()
                .asFile
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le mock de <code>buildDirectory.dir()</code> retournait <code>null</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="la_solution_4">6.2. La solution</h3>
<div class="paragraph">
<p>Mocker <code>afterEvaluate</code> pour qu&#8217;il s&#8217;exécute immédiatement, et configurer complètement <code>buildDirectory</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">private fun createMockProject(): Pair&lt;Project, PluginContainer&gt; {
    // ... autres mocks ...

    val mockBuildDirectory = mock&lt;DirectoryProperty&gt;()
    val buildDir = File(projectDir, "build")

    // Mocker dir() pour retourner un Provider valide
    whenever(mockBuildDirectory.dir(any&lt;String&gt;())).doAnswer { invocation -&gt;
        val path = invocation.arguments[0] as String
        val mockDirProvider = mock&lt;Provider&lt;Directory&gt;&gt;()
        val mockDir = mock&lt;Directory&gt;()

        whenever(mockDir.asFile).thenReturn(File(buildDir, path))
        whenever(mockDirProvider.get()).thenReturn(mockDir)

        mockDirProvider
    }

    // Mocker afterEvaluate pour exécution immédiate
    whenever(mockProject.afterEvaluate(any&lt;Action&lt;Project&gt;&gt;())).doAnswer { invocation -&gt;
        val action = invocation.arguments[0] as Action&lt;Project&gt;
        action.execute(mockProject)  // ✅ Exécution synchrone
        null
    }

    return Pair(mockProject, mockPluginContainer)
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/after-evaluate-flow.svg" alt="after evaluate flow" width="777" height="357">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="la_solution_complète">7. La solution complète</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Voici la fonction <code>createMockProject()</code> finale, qui résout tous les problèmes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">private fun createMockProject(): Pair&lt;Project, PluginContainer&gt; {
    // 1️⃣ CRÉER tous les mocks (pas de nested mocks !)
    val mockPluginContainer = mock&lt;PluginContainer&gt;()
    val mockExtensionContainer = mock&lt;ExtensionContainer&gt;()
    val mockLogger = mock&lt;org.gradle.api.logging.Logger&gt;()
    val mockTaskContainer = mock&lt;TaskContainer&gt;()
    val mockConfigPathProperty = mock&lt;Property&lt;String&gt;&gt;()
    val mockBakeryExtension = mock&lt;BakeryExtension&gt;()
    val mockProjectDirectory = mock&lt;Directory&gt;()
    val mockBuildDirectory = mock&lt;DirectoryProperty&gt;()
    val mockProjectLayout = mock&lt;ProjectLayout&gt;()
    val mockProject = mock&lt;Project&gt;()

    // 2️⃣ CONFIGURER la résolution des chemins
    val configFile = File("../../site.yml").canonicalFile
    val projectDir = configFile.parentFile
    val buildDir = File(projectDir, "build")

    whenever(mockConfigPathProperty.get()).thenReturn("site.yml")
    whenever(mockConfigPathProperty.isPresent).thenReturn(true)
    whenever(mockBakeryExtension.configPath).thenReturn(mockConfigPathProperty)
    whenever(mockProjectDirectory.asFile).thenReturn(projectDir)

    // 3️⃣ CONFIGURER buildDirectory avec dir()
    whenever(mockBuildDirectory.dir(any&lt;String&gt;())).doAnswer { invocation -&gt;
        val path = invocation.arguments[0] as String
        val mockDirProvider = mock&lt;Provider&lt;Directory&gt;&gt;()
        val mockDir = mock&lt;Directory&gt;()
        whenever(mockDir.asFile).thenReturn(File(buildDir, path))
        whenever(mockDirProvider.get()).thenReturn(mockDir)
        mockDirProvider
    }

    // 4️⃣ ASSEMBLER le projet
    whenever(mockProjectLayout.projectDirectory).thenReturn(mockProjectDirectory)
    whenever(mockProjectLayout.buildDirectory).thenReturn(mockBuildDirectory)

    whenever(mockExtensionContainer.create("bakery", BakeryExtension::class.java))
        .thenReturn(mockBakeryExtension)
    whenever(mockExtensionContainer.getByType(BakeryExtension::class.java))
        .thenReturn(mockBakeryExtension)

    whenever(mockProject.extensions).thenReturn(mockExtensionContainer)
    whenever(mockProject.plugins).thenReturn(mockPluginContainer)
    whenever(mockProject.tasks).thenReturn(mockTaskContainer)
    whenever(mockProject.layout).thenReturn(mockProjectLayout)
    whenever(mockProject.logger).thenReturn(mockLogger)
    whenever(mockProject.projectDir).thenReturn(projectDir)

    // 5️⃣ CONFIGURER afterEvaluate pour exécution immédiate
    whenever(mockProject.afterEvaluate(any&lt;Action&lt;Project&gt;&gt;())).doAnswer { invocation -&gt;
        val action = invocation.arguments[0] as Action&lt;Project&gt;
        action.execute(mockProject)
        null
    }

    return Pair(mockProject, mockPluginContainer)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et le test final qui passe :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Test
fun `plugin applies jbake gradle plugin`() {
    val (project, mockPluginContainer) = createMockProject()
    val plugin = BakeryPlugin()

    plugin.apply(project)

    verify(mockPluginContainer).apply(JBakePlugin::class.java) // ✅ SUCCÈS !
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="leçons_apprises">8. Leçons apprises</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/lessons-learned.svg" alt="lessons learned" width="748" height="472">
</div>
</div>
<div class="sect2">
<h3 id="1_vérifier_le_bon_mock">8.1. 1. Vérifier le bon mock</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// ❌ FAUX
verify(project.plugins).apply(JBakePlugin::class.java)

// ✅ CORRECT
val (project, mockPluginContainer) = createMockProject()
verify(mockPluginContainer).apply(JBakePlugin::class.java)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="2_éviter_les_mocks_imbriqués">8.2. 2. Éviter les mocks imbriqués</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// ❌ FAUX - UnfinishedStubbingException
val mockProject = mock&lt;Project&gt; {
    on { logger } doReturn mock()  // Nested mock creation !
}

// ✅ CORRECT - Créer séparément
val mockLogger = mock&lt;org.gradle.api.logging.Logger&gt;()
val mockProject = mock&lt;Project&gt;()
whenever(mockProject.logger).thenReturn(mockLogger)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="3_mocker_les_callbacks_dévaluation">8.3. 3. Mocker les callbacks d&#8217;évaluation</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// ✅ afterEvaluate doit s'exécuter pour les tests
whenever(mockProject.afterEvaluate(any())).doAnswer { invocation -&gt;
    val action = invocation.arguments[0] as Action&lt;Project&gt;
    action.execute(mockProject)
    null
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="4_tester_la_résolution_des_chemins">8.4. 4. Tester la résolution des chemins</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// Toujours vérifier que les chemins se résolvent correctement
val extension = project.extensions.getByType(BakeryExtension::class.java)
val configPath = extension.configPath.get()
val projectDir = project.layout.projectDirectory.asFile
val resolvedConfig = projectDir.resolve(configPath)

println("Resolved config: ${resolvedConfig.absolutePath}")
println("Exists: ${resolvedConfig.exists()}")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture_de_test_finale">9. Architecture de test finale</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/test-architecture.svg" alt="test architecture" width="707" height="598">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">10. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce qui semblait être un simple problème de test s&#8217;est révélé être un excellent cas d&#8217;étude sur :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les subtilités de Mockito avec Kotlin</p>
</li>
<li>
<p>L&#8217;importance de mocker les bons objets</p>
</li>
<li>
<p>La gestion des callbacks asynchrones dans les tests</p>
</li>
<li>
<p>La résolution de chemins dans les plugins Gradle</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le debugging méthodique, en comprenant chaque couche du problème, a permis d&#8217;arriver à une solution robuste et maintenable.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Conseil pour vos tests</strong> : Si vous rencontrez "Wanted but not invoked" avec Mockito, demandez-vous toujours :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Est-ce que je vérifie le bon mock ?</p>
</li>
<li>
<p>Est-ce que tous mes mocks sont créés en dehors des blocs de configuration ?</p>
</li>
<li>
<p>Est-ce que mes callbacks s&#8217;exécutent vraiment ?</p>
</li>
<li>
<p>Est-ce que mes chemins se résolvent correctement ?</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ressources">11. Ressources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/mockito/mockito-kotlin">Mockito-Kotlin Documentation</a></p>
</li>
<li>
<p><a href="https://docs.gradle.org/current/userguide/custom_plugins.html">Gradle Plugin Development Guide</a></p>
</li>
<li>
<p><a href="https://jbake.org/">JBake Static Site Generator</a></p>
</li>
</ul>
</div>
<hr>
<div class="paragraph">
<p><em>Avez-vous rencontré des problèmes similaires dans vos tests ? Partagez votre expérience dans les commentaires !</em></p>
</div>
</div>
</div></div>

            <!-- Section Commentaires Disqus -->
            <section id="disqus_thread" class="mt-5"></section>
            <script>
                /*<![CDATA[*/
                var disqus_identifier = "blog\/2025\/0099_debugging-mockito-gradle-plugin_post.html";

                (({disqus_shortname, document}) => {
                    injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
                    injectScript('//' + disqus_shortname + '.disqus.com/count.js');

                    function injectScript(url) {
                        const s = document.createElement('script');
                        s.async = true;
                        s.src = url;
                        (document.head || document.body).appendChild(s);
                    }
                })({'disqus_shortname': 'cheroliv', 'document': document});
                /*]]>*/
            </script>
            <noscript>
                <div class="alert alert-warning">
                    Veuillez activer JavaScript pour voir les
                    <a href="https://disqus.com/?ref_noscript" class="alert-link">commentaires propulsés par Disqus</a>.
                </div>
            </noscript>

        </article>
    </main>
</div>

<div>
    <!-- Footer -->
    <footer class="enhanced-footer">
        <div class="container">
            <div class="row">
                <!-- Brand Section -->
                <div class="col-lg-2 col-md-6 mb-4 mb-lg-0">
                    <h5 class="fw-bold">
                        <i class="bi bi-code-slash me-2"></i>
                        CHEROLIV
                    </h5>
                    <p class="footer-description">
                        Développeur formateur spécialisé en ingénierie pédagogique.
                        Conception de solutions e-learning innovantes pour transformer l'apprentissage.
                    </p>
                    <div class="social-icons">
                        <a href="https://github.com/cheroliv" target="_blank" aria-label="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                        <!--                        <a href="#" aria-label="LinkedIn">-->
                        <!--                            <i class="fab fa-linkedin-in"></i>-->
                        <!--                        </a>-->
                        <!--                        <a href="#" aria-label="Twitter">-->
                        <!--                            <i class="fab fa-twitter"></i>-->
                        <!--                        </a>-->
                        <a href="feed.xml" aria-label="RSS Feed">
                            <i class="fas fa-rss"></i>
                        </a>
                        <a href="mailto:cheroliv.developer@gmail.com" target="_blank" aria-label="Mail">
                            <i class="fas fa-paper-plane"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6 mb-4 mb-lg-0">
                    <h6 class="fw-bold">Navigation</h6>
                    <ul class="footer-links">
                        <li><a href="../../index.html"><i class="bi bi-chevron-right"></i>Accueil</a></li>
                        <!--                        <li><a th:href="${content.rootpath} + 'index.html#about'"><i class="bi bi-chevron-right"></i>À propos</a></li>-->
                        <li><a href="../../index.html#services"><i class="bi bi-chevron-right"></i>Services</a></li>
                        <!--                        <li><a th:href="${content.rootpath} + 'index.html#portfolio'"><i class="bi bi-chevron-right"></i>Portfolio</a></li>-->
                        <li><a href="../../blog.html"><i class="bi bi-chevron-right"></i>Blog</a></li>
                    </ul>
                </div>

                <!-- Resources -->
                <div class="col-lg-2 col-md-6 mb-4 mb-lg-0">
                    <h6 class="fw-bold">Ressources</h6>
                    <ul class="footer-links">
                        <!--                        <li><a th:href="${content.rootpath} + 'index.html#formations'"><i class="bi bi-book"></i>Formations</a></li>-->
                        <li><a href="../../blog.html"><i class="bi bi-journal-text"></i>Articles</a></li>
                        <li><a href="../../archive.html"><i class="bi bi-archive"></i>Archives</a></li>
                        <li><a><i class="bi bi-journal-bookmark"></i>Mémos</a></li>
                        <li><a href="https://pages-content.github.io/slides/" target="_blank"><i class="fa-regular fa-file-powerpoint"></i> slides</a></li>
                        <li><a href="https://talaria-formation.github.io/formations/index.html" target="_blank"><i class="fa-solid fa-graduation-cap"></i> trainings</a></li>
                        <!--                        <li><a href="#"><i class="bi bi-file-earmark-pdf"></i>Documentation</a></li>-->
                        <!--                        <li><a href="#"><i class="bi bi-youtube"></i>Tutoriels vidéo</a></li>-->
                    </ul>
                </div>

                <!-- Contact Section -->
<!--                <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">-->
<!--                    <h6 class="fw-bold">Me contacter</h6>-->
<!--                    <p class="mb-3">Une question ? Un projet ? N'hésitez pas à me contacter.</p>-->
<!--                    <ul class="contact-info">-->
<!--                        <li>-->
<!--                            <i class="bi bi-envelope-fill"></i>-->
<!--                            <a th:href="${content.rootpath} + 'index.html#contact'">-->
<!--                                Formulaire de contact-->
<!--                            </a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <i class="bi bi-clock-fill"></i>-->
<!--                            <span>Réponse sous 24-48h</span>-->
<!--                        </li>-->
<!--                    </ul>-->
<!--                </div>-->

                <!-- Location Section -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="fw-bold">Localisation</h6>
                    <p class="mb-3">Basé en région parisienne, interventions possibles en France et à distance.</p>
                    <ul class="contact-info">
                        <li>
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>Île-de-France, France</span>
                        </li>
                        <li>
                            <i class="bi bi-globe"></i>
                            <span>Télétravail disponible</span>
                        </li>
                        <li>
                            <i class="bi bi-pin-map-fill"></i>
                            <span>Déplacements en France</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Footer Bottom -->
            <hr class="footer-divider">
            <div class="footer-bottom">
                <p>&copy; 2018-<span>2026</span> Cheroliv. Tous droits réservés.</p>
                <div class="footer-bottom-links">
                    <a href="#">Politique de confidentialité</a>
                    <a href="#">Conditions d'utilisation</a>
                    <a href="#">Mentions légales</a>
                    <a href="#">Plan du site</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Credentials Injection -->
    <script>
        /*<![CDATA[*/
        const SUPABASE_URL = null;
        const SUPABASE_KEY = null;
        /*]]>*/
    </script>
    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/go.min.js"></script>
    <script>hljs.highlightAll();</script>
    <!-- intl-tel-input JS -->
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@25.10.1/build/js/intlTelInput.min.js"></script>
    <!-- Custom JS -->
    <script src="../../js/script.js"></script>
    <script src="../../js/contact.js"></script>
</div>
</body>
</html>
